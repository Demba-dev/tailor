{% extends 'base.html' %}
{% load static %}

{% block title %}Messages envoyés | {{ site_settings.nom_atelier }}{% endblock %}

{% block extra_css %}
<style>
    .sent-messages-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* Header avec statistiques */
    .sent-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .sent-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    }
    
    .header-content {
        position: relative;
        z-index: 2;
    }
    
    .header-title {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .header-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    .sent-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }
    
    .sent-stat-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    
    .sent-stat-card:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-5px);
    }
    
    .sent-stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .sent-stat-content h3 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }
    
    .sent-stat-content p {
        font-size: 0.9rem;
        opacity: 0.8;
        margin: 0;
    }
    
    /* Tabs améliorées */
    .messages-tabs {
        display: flex;
        background: white;
        border-radius: 16px;
        padding: 0.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        border: 1px solid #e2e8f0;
    }
    
    .tab-item {
        flex: 1;
        padding: 1rem 1.5rem;
        border: none;
        background: none;
        border-radius: 12px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        position: relative;
        text-decoration: none;
    }
    
    .tab-item:hover {
        background: #f8fafc;
        color: #475569;
        text-decoration: none;
    }
    
    .tab-item.active {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    
    /* Barre d'outils */
    .sent-toolbar {
        background: white;
        border-radius: 16px;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .toolbar-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .toolbar-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .search-box {
        position: relative;
        width: 300px;
    }
    
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .search-input:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        outline: none;
    }
    
    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }
    
    .filter-dropdown {
        position: relative;
    }
    
    .filter-btn {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-weight: 500;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .filter-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    
    .filter-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        padding: 0.5rem;
        min-width: 200px;
        z-index: 1000;
        display: none;
    }
    
    .filter-item {
        padding: 0.75rem 1rem;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        color: #475569;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .filter-item:hover {
        background: #f8fafc;
    }
    
    .filter-item.active {
        background: #f0f9ff;
        color: #10b981;
    }
    
    .action-btn {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.75rem;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    .action-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #1e293b;
    }
    
    .action-btn.primary {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
    }
    
    .action-btn.primary:hover {
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        transform: translateY(-2px);
    }
    
    /* Table améliorée */
    .sent-table-container {
        background: white;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    
    .sent-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table-header {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-bottom: 1px solid #e2e8f0;
    }
    
    .table-header th {
        padding: 1.25rem 1.5rem;
        font-weight: 600;
        color: #475569;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
    }
    
    .table-header th:first-child {
        border-radius: 20px 0 0 0;
    }
    
    .table-header th:last-child {
        border-radius: 0 20px 0 0;
    }
    
    .sent-row {
        border-bottom: 1px solid #f1f5f9;
        transition: all 0.2s ease;
        position: relative;
        background: white;
    }
    
    .sent-row:last-child {
        border-bottom: none;
    }
    
    .sent-row:hover {
        background: #f8fafc;
        transform: translateX(4px);
    }
    
    .sent-row.delivered {
        border-left: 3px solid #10b981;
    }
    
    .sent-row.read {
        border-left: 3px solid #3b82f6;
    }
    
    .sent-row.failed {
        border-left: 3px solid #ef4444;
    }
    
    .sent-row td {
        padding: 1.25rem 1.5rem;
        border: none;
        vertical-align: middle;
    }
    
    /* Destinataire */
    .recipient-cell {
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 250px;
    }
    
    .recipient-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
    }
    
    .recipient-info {
        flex: 1;
        min-width: 0;
    }
    
    .recipient-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .recipient-email {
        font-size: 0.85rem;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Sujet et message */
    .subject-cell {
        min-width: 300px;
        max-width: 400px;
    }
    
    .subject-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .subject-text {
        font-weight: 500;
        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }
    
    .message-preview {
        font-size: 0.9rem;
        color: #64748b;
        margin-top: 0.25rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    /* Badges de statut */
    .status-badges {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .badge-delivered {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        font-size: 0.7rem;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .badge-read {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        font-size: 0.7rem;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .badge-failed {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-size: 0.7rem;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .badge-attachment {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        font-size: 0.7rem;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    /* Date et statut */
    .date-cell {
        text-align: center;
        min-width: 150px;
    }
    
    .date-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }
    
    .date-day {
        font-weight: 600;
        color: #1e293b;
    }
    
    .date-time {
        font-size: 0.85rem;
        color: #64748b;
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }
    
    /* Actions */
    .actions-cell {
        text-align: right;
        min-width: 180px;
    }
    
    .actions-container {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    .action-icon-btn {
        background: none;
        border: none;
        padding: 0.5rem;
        color: #94a3b8;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }
    
    .action-icon-btn:hover {
        background: #f1f5f9;
        color: #475569;
    }
    
    .action-icon-btn:active {
        transform: scale(0.95);
    }
    
    .action-icon-btn.forward:hover {
        color: #10b981;
    }
    
    .action-icon-btn.resend:hover {
        color: #f59e0b;
    }
    
    .action-icon-btn.delete:hover {
        color: #ef4444;
    }
    
    .action-icon-btn i {
        pointer-events: none;
    }
    
    .btn-details {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }
    
    .btn-details:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        color: white;
        text-decoration: none;
    }
    
    /* État vide */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }
    
    .empty-state-icon {
        width: 80px;
        height: 80px;
        border-radius: 20px;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #94a3b8;
        margin: 0 auto 1.5rem;
    }
    
    .empty-state-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }
    
    .empty-state-subtitle {
        color: #64748b;
        margin-bottom: 2rem;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    
    /* Graphique d'activité */
    .activity-chart {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }
    
    .chart-container {
        height: 150px;
        position: relative;
        overflow: hidden;
    }
    
    .chart-bars {
        display: flex;
        align-items: flex-end;
        gap: 1rem;
        height: 100%;
        padding: 0 1rem;
    }
    
    .chart-bar {
        flex: 1;
        background: linear-gradient(to top, #10b981, #34d399);
        border-radius: 8px 8px 0 0;
        position: relative;
        transition: all 0.3s ease;
        min-height: 20px;
    }
    
    .chart-bar:hover {
        opacity: 0.8;
        transform: scaleY(1.05);
    }
    
    .chart-label {
        position: absolute;
        bottom: -2rem;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 0.8rem;
        color: #64748b;
    }
    
    .chart-value {
        position: absolute;
        top: -1.5rem;
        left: 0;
        right: 0;
        text-align: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #10b981;
    }
    
    /* Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .sent-row {
        animation: fadeIn 0.3s ease forwards;
        opacity: 0;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
        .sent-toolbar {
            flex-direction: column;
            gap: 1rem;
        }
        
        .toolbar-left,
        .toolbar-right {
            width: 100%;
        }
        
        .search-box {
            width: 100%;
        }
        
        .sent-table {
            display: block;
            overflow-x: auto;
        }
        
        .recipient-cell {
            min-width: 200px;
        }
        
        .subject-cell {
            min-width: 250px;
        }
        
        .actions-container {
            flex-direction: column;
            align-items: flex-end;
        }
    }
    
    @media (max-width: 768px) {
        .sent-header {
            padding: 1.5rem;
        }
        
        .header-title {
            font-size: 1.5rem;
        }
        
        .sent-stats {
            grid-template-columns: 1fr;
        }
        
        .messages-tabs {
            flex-direction: column;
            padding: 0.25rem;
        }
        
        .tab-item {
            padding: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="sent-messages-container">
    {% csrf_token %}
    <!-- En-tête avec statistiques -->
    <div class="sent-header animate__animated animate__fadeIn">
        <div class="header-content">
            <h1 class="header-title">
                <i class="fas fa-paper-plane"></i>
                Messages envoyés
            </h1>
            <p class="header-subtitle">
                Historique de vos communications sortantes
            </p>
            
            <div class="sent-stats">
                <div class="sent-stat-card">
                    <div class="sent-stat-icon">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="sent-stat-content">
                        <h3>{{ total_sent|default:"0" }}</h3>
                        <p>Messages envoyés</p>
                    </div>
                </div>
                
                <div class="sent-stat-card">
                    <div class="sent-stat-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="sent-stat-content">
                        <h3>{{ read_count|default:"0" }}</h3>
                        <p>Messages lus</p>
                    </div>
                </div>
                
                <div class="sent-stat-card">
                    <div class="sent-stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="sent-stat-content">
                        <h3>{{ read_percentage|default:"0" }}%</h3>
                        <p>Taux de lecture</p>
                    </div>
                </div>
                
                <div class="sent-stat-card">
                    <div class="sent-stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="sent-stat-content">
                        <h3>{{ this_month|default:"0" }}</h3>
                        <p>Ce mois-ci</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphique d'activité -->
    <div class="activity-chart">
        <div class="chart-header">
            <h3 class="chart-title">Activité d'envoi des 7 derniers jours</h3>
            <button class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-calendar-alt me-2"></i>7 jours
            </button>
        </div>
        <div class="chart-container">
            <div class="chart-bars">
                {% for day in activity_data %}
                <div class="chart-bar" style="height: '{{ day.value }}'%" 
                     title="{{ day.count }} messages le {{ day.date }}">
                    <div class="chart-value">{{ day.count }}</div>
                    <div class="chart-label">{{ day.day }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Onglets de navigation -->
    <div class="messages-tabs">
        <a href="{% url 'messagerie:inbox' %}" class="tab-item {% if active_tab == 'inbox' %}active{% endif %}">
            <i class="fas fa-inbox"></i>
            <span>Boîte de réception</span>
        </a>
        
        <a href="{% url 'messagerie:sent_messages' %}" class="tab-item active">
            <i class="fas fa-paper-plane"></i>
            <span>Messages envoyés</span>
        </a>
        
        <a href="{% url 'messagerie:compose' %}" class="tab-item">
            <i class="fas fa-edit"></i>
            <span>Rédiger</span>
        </a>
    </div>

    <!-- Barre d'outils -->
    <div class="sent-toolbar">
        <div class="toolbar-left">
            <!-- Barre de recherche -->
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" 
                       class="search-input" 
                       placeholder="Rechercher dans les messages envoyés..."
                       id="sentSearch"
                       onkeyup="searchSentMessages()">
            </div>
            
            <!-- Filtres -->
            <div class="filter-dropdown">
                <button class="filter-btn" onclick="toggleFilterMenu()">
                    <i class="fas fa-filter"></i>
                    <span id="filterText">Tous les statuts</span>
                    <i class="fas fa-chevron-down ms-2"></i>
                </button>
                <div class="filter-menu" id="filterMenu">
                    <button class="filter-item active" onclick="filterByStatus(event, 'all')">
                        <i class="fas fa-bars"></i>
                        Tous les statuts
                    </button>
                    <button class="filter-item" onclick="filterByStatus(event, 'read')">
                        <i class="fas fa-eye"></i>
                        Messages lus
                    </button>
                    <button class="filter-item" onclick="filterByStatus(event, 'delivered')">
                        <i class="fas fa-check-circle"></i>
                        Livrés
                    </button>
                    <button class="filter-item" onclick="filterByStatus(event, 'failed')">
                        <i class="fas fa-exclamation-circle"></i>
                        Échecs
                    </button>
                    <button class="filter-item" onclick="filterByStatus(event, 'today')">
                        <i class="fas fa-calendar-day"></i>
                        Aujourd'hui
                    </button>
                    <button class="filter-item" onclick="filterByStatus(event, 'week')">
                        <i class="fas fa-calendar-week"></i>
                        Cette semaine
                    </button>
                </div>
            </div>
        </div>
        
        <div class="toolbar-right">
            <!-- Actions de suppression -->
            <button class="action-btn" id="bulkDeleteBtn" onclick="deleteSelectedSentMessages()" title="Supprimer les sélectionnés" style="display: none;">
                <i class="fas fa-trash"></i>
            </button>
            
            <!-- Trier -->
            <div class="filter-dropdown">
                <button class="filter-btn" onclick="toggleSortMenu()">
                    <i class="fas fa-sort-amount-down"></i>
                    <span id="sortText">Plus récents</span>
                    <i class="fas fa-chevron-down ms-2"></i>
                </button>
                <div class="filter-menu" id="sortMenu">
                    <button class="filter-item active" onclick="sortBy(event, 'recent')">
                        <i class="fas fa-clock"></i>
                        Plus récents
                    </button>
                    <button class="filter-item" onclick="sortBy(event, 'oldest')">
                        <i class="fas fa-history"></i>
                        Plus anciens
                    </button>
                    <button class="filter-item" onclick="sortBy(event, 'recipient')">
                        <i class="fas fa-user"></i>
                        Destinataire (A-Z)
                    </button>
                    <button class="filter-item" onclick="sortBy(event, 'subject')">
                        <i class="fas fa-tag"></i>
                        Sujet (A-Z)
                    </button>
                </div>
            </div>
            
            <!-- Actions -->
            <button class="action-btn" onclick="refreshSentMessages(event)" title="Actualiser">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <a href="{% url 'messagerie:compose' %}" class="action-btn primary" title="Nouveau message">
                <i class="fas fa-plus"></i>
            </a>
        </div>
    </div>

    <!-- Table des messages envoyés -->
    <div class="sent-table-container">
        {% if sent_messages %}
        <table class="sent-table">
            <thead class="table-header">
                <tr>
                    <th style="width: 40px;"></th>
                    <th style="min-width: 250px;">Destinataire</th>
                    <th style="min-width: 400px;">Sujet</th>
                    <th style="width: 150px;">Date & Statut</th>
                    <th style="width: 200px;" class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for msg in sent_messages %}
                {% with status=msg.get_status %}
                <tr class="sent-row {{ status }}" 
                    data-message-id="{{ msg.pk }}"
                    data-status="{{ status }}"
                    data-recipient="{{ msg.recipient.nom|lower }} {{ msg.recipient.prenom|lower }}"
                    data-subject="{{ msg.subject|lower }}"
                    data-date="{{ msg.created_at|date:'Y-m-d' }}"
                    onclick="toggleMessageSelection(event, this)">
                    <td>
                        <input type="checkbox" 
                               class="message-checkbox message-select" 
                               value="{{ msg.pk }}"
                               onclick="event.stopPropagation()">
                    </td>
                    
                    <td>
                        <div class="recipient-cell">
                            <div class="recipient-avatar">
                                {{ msg.recipient.nom|first|upper }}
                            </div>
                            <div class="recipient-info">
                                <div class="recipient-name">
                                    {{ msg.recipient.prenom }} {{ msg.recipient.nom }}
                                </div>
                                <div class="recipient-email">
                                    {{ msg.recipient.email|default:"N/A" }}
                                </div>
                            </div>
                        </div>
                    </td>
                    
                    <td class="subject-cell">
                        <div class="subject-content">
                            <div class="subject-text">
                                {{ msg.subject|default:"(Sans objet)" }}
                            </div>
                            {% if status == 'read' %}
                            <span class="badge-read">
                                <i class="fas fa-eye me-1"></i>Lu
                            </span>
                            {% elif status == 'delivered' %}
                            <span class="badge-delivered">
                                <i class="fas fa-check-circle me-1"></i>Livré
                            </span>
                            {% elif status == 'failed' %}
                            <span class="badge-failed">
                                <i class="fas fa-exclamation-circle me-1"></i>Échec
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="message-preview">
                            {{ msg.body|truncatechars:100 }}
                        </div>
                        
                        {% if msg.attachments.exists %}
                        <div class="status-badges">
                            <span class="badge-attachment">
                                <i class="fas fa-paperclip me-1"></i>
                                {{ msg.attachments.count }}
                            </span>
                        </div>
                        {% endif %}
                    </td>
                    
                    <td class="date-cell">
                        <div class="date-content">
                            <div class="date-day">
                                {{ msg.created_at|date:"d M Y" }}
                            </div>
                            <div class="date-time">
                                {{ msg.created_at|date:"H:i" }}
                            </div>
                            <div class="status-indicator">
                                {% if status == 'read' %}
                                <i class="fas fa-circle text-blue-500"></i>
                                <span class="text-blue-500">Lu</span>
                                {% elif status == 'delivered' %}
                                <i class="fas fa-circle text-green-500"></i>
                                <span class="text-green-500">Livré</span>
                                {% elif status == 'failed' %}
                                <i class="fas fa-circle text-red-500"></i>
                                <span class="text-red-500">Échec</span>
                                {% else %}
                                <i class="fas fa-circle text-gray-400"></i>
                                <span class="text-gray-400">Envoyé</span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    
                    <td class="actions-cell">
                        <div class="actions-container">
                            <button type="button" class="action-icon-btn forward" 
                                    onclick="forwardMessage(event, '{{ msg.pk }}')"
                                    title="Transférer">
                                <i class="fas fa-share"></i>
                            </button>
                            
                            <button type="button" class="action-icon-btn resend" 
                                    onclick="resendMessage(event, '{{ msg.pk }}')"
                                    title="Renvoyer">
                                <i class="fas fa-redo"></i>
                            </button>
                            
                            <button type="button" class="action-icon-btn delete" 
                                    onclick="deleteSentMessage(event, '{{ msg.pk }}')"
                                    title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                            
                            <a href="{% url 'messagerie:message_detail' msg.pk %}" 
                               class="btn-details">
                                <i class="fas fa-eye"></i>
                                Détails
                            </a>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        <div class="messages-pagination">
            <div class="pagination-info">
                Affichage de {{ sent_messages.start_index|default:1 }} à {{ sent_messages.end_index|default:sent_messages|length }} sur {{ sent_messages.paginator.count }} messages envoyés
            </div>
            
            <div class="pagination-controls">
                {% if sent_messages.has_previous %}
                <button class="pagination-btn" onclick="goToPage('{{ sent_messages.previous_page_number }}')">
                    <i class="fas fa-chevron-left"></i>
                    Précédent
                </button>
                {% endif %}
                
                {% for num in sent_messages.paginator.page_range %}
                    {% if num == sent_messages.number %}
                    <button class="pagination-btn active">{{ num }}</button>
                    {% else %}
                        {% if num > sent_messages.number|add:"-3" and num < sent_messages.number|add:"3" %}
                        <button class="pagination-btn" onclick="goToPage('{{ num }}')">{{ num }}</button>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                
                {% if sent_messages.has_next %}
                <button class="pagination-btn" onclick="goToPage('{{ sent_messages.next_page_number }}')">
                    Suivant
                    <i class="fas fa-chevron-right"></i>
                </button>
                {% endif %}
            </div>
        </div>
        
        {% else %}
        <!-- État vide -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <h3 class="empty-state-title">Vous n'avez envoyé aucun message</h3>
            <p class="empty-state-subtitle">
                Lorsque vous enverrez des messages, ils apparaîtront ici avec leur statut et leurs détails.
            </p>
            <a href="{% url 'messagerie:compose' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-paper-plane me-2"></i>
                Envoyer votre premier message
            </a>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>


let selectedMessages = new Set();
let currentAction = null;
let confirmModal = null;


document.addEventListener('DOMContentLoaded', function() {
    // Créer une instance unique de la modal de confirmation
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    // Initialiser les fonctionnalités
    initializeSentTable();
    initializeSearch();
    initializeFilters();
    initializeKeyboardShortcuts();
    
    // Animation des lignes
    animateSentRows();
    
    // Attacher le listener du bouton de confirmation
    const confirmBtn = document.getElementById('confirmActionBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            if (currentAction) {
                currentAction();
                currentAction = null;
            }
            confirmModal.hide();
        });
    }
});

function initializeSentTable() {
    // Gestion des clics sur les lignes
    const rows = document.querySelectorAll('.sent-row');
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.action-icon-btn') && !e.target.closest('.btn-details')) {
                // Naviguer vers les détails
                const detailsLink = this.querySelector('.btn-details');
                if (detailsLink) {
                    detailsLink.click();
                }
            }
        });
    });
}

function initializeSearch() {
    const searchInput = document.getElementById('sentSearch');
    if (!searchInput) return;
    
    // Raccourci clavier Ctrl+F
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            searchInput.focus();
        }
    });
    
    // Effacer la recherche avec Échap
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            searchSentMessages();
        }
    });
}

function searchSentMessages() {
    const query = document.getElementById('sentSearch').value.toLowerCase();
    const rows = document.querySelectorAll('.sent-row');
    
    rows.forEach(row => {
        const recipient = row.dataset.recipient || '';
        const subject = row.dataset.subject || '';
        const text = row.textContent.toLowerCase();
        
        if (recipient.includes(query) || subject.includes(query) || text.includes(query)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function initializeFilters() {
    // Gestion des menus de filtre
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-dropdown')) {
            document.querySelectorAll('.filter-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });
}

function toggleFilterMenu() {
    const menu = document.getElementById('filterMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function toggleSortMenu() {
    const menu = document.getElementById('sortMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function filterByStatus(event, status) {
    const rows = document.querySelectorAll('.sent-row');
    const filterText = document.getElementById('filterText');
    
    // Mettre à jour le texte du bouton
    switch(status) {
        case 'all':
            filterText.textContent = 'Tous les statuts';
            break;
        case 'read':
            filterText.textContent = 'Messages lus';
            break;
        case 'delivered':
            filterText.textContent = 'Livrés';
            break;
        case 'failed':
            filterText.textContent = 'Échecs';
            break;
        case 'today':
            filterText.textContent = 'Aujourd\'hui';
            break;
        case 'week':
            filterText.textContent = 'Cette semaine';
            break;
    }
    
    // Mettre à jour les classes actives
    document.querySelectorAll('#filterMenu .filter-item').forEach(item => {
        item.classList.remove('active');
    });
    if (event && event.target) event.target.classList.add('active');
    
    // Filtrer les lignes
    const today = new Date().toISOString().split('T')[0];
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weekAgoStr = weekAgo.toISOString().split('T')[0];
    
    rows.forEach(row => {
        const rowStatus = row.dataset.status;
        const rowDate = row.dataset.date;
        
        let shouldShow = false;
        
        switch(status) {
            case 'all':
                shouldShow = true;
                break;
            case 'read':
                shouldShow = rowStatus === 'read';
                break;
            case 'delivered':
                shouldShow = rowStatus === 'delivered';
                break;
            case 'failed':
                shouldShow = rowStatus === 'failed';
                break;
            case 'today':
                shouldShow = rowDate === today;
                break;
            case 'week':
                shouldShow = rowDate >= weekAgoStr;
                break;
        }
        
        row.style.display = shouldShow ? '' : 'none';
    });
    
    // Fermer le menu
    document.getElementById('filterMenu').style.display = 'none';
}

function sortBy(event, criteria) {
    const rows = Array.from(document.querySelectorAll('.sent-row'));
    const sortText = document.getElementById('sortText');
    
    // Mettre à jour le texte du bouton
    switch(criteria) {
        case 'recent':
            sortText.textContent = 'Plus récents';
            break;
        case 'oldest':
            sortText.textContent = 'Plus anciens';
            break;
        case 'recipient':
            sortText.textContent = 'Destinataire (A-Z)';
            break;
        case 'subject':
            sortText.textContent = 'Sujet (A-Z)';
            break;
    }
    
    // Mettre à jour les classes actives
    document.querySelectorAll('#sortMenu .filter-item').forEach(item => {
        item.classList.remove('active');
    });
    if (event && event.target) event.target.classList.add('active');
    
    // Trier les lignes
    rows.sort((a, b) => {
        switch(criteria) {
            case 'recent':
                return new Date(b.dataset.date) - new Date(a.dataset.date);
            case 'oldest':
                return new Date(a.dataset.date) - new Date(b.dataset.date);
            case 'recipient':
                const recipientA = a.dataset.recipient || '';
                const recipientB = b.dataset.recipient || '';
                return recipientA.localeCompare(recipientB);
            case 'subject':
                const subjectA = a.dataset.subject || '';
                const subjectB = b.dataset.subject || '';
                return subjectA.localeCompare(subjectB);
            default:
                return 0;
        }
    });
    
    // Réorganiser le DOM
    const tbody = document.querySelector('.sent-table tbody');
    rows.forEach(row => tbody.appendChild(row));
    
    // Fermer le menu
    document.getElementById('sortMenu').style.display = 'none';
}

// Sélection des messages
function toggleMessageSelection(event, row) {
    const checkbox = row.querySelector('.message-select');
    if (checkbox && !event.target.closest('.action-icon-btn')) {
        checkbox.checked = !checkbox.checked;
        updateMessageSelection(checkbox);
    }
}

function updateMessageSelection(checkbox) {
    const messageId = checkbox.value;
    
    if (checkbox.checked) {
        selectedMessages.add(messageId);
        checkbox.closest('.sent-row').classList.add('selected');
    } else {
        selectedMessages.delete(messageId);
        checkbox.closest('.sent-row').classList.remove('selected');
    }
    
    updateBulkActions();
}

function updateBulkActions() {
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    if (selectedMessages.size > 0) {
        bulkDeleteBtn.style.display = 'flex';
    } else {
        bulkDeleteBtn.style.display = 'none';
    }
}

// Actions sur les messages
function forwardMessage(event, messageId) {
    if (event) event.stopPropagation();
    showConfirmation('Transférer ce message ?', function() {
        fetch(`/messages/message/${messageId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.text())
        .then(data => {
            window.location.href = `/messages/compose/?forward=${messageId}`;
        })
        .catch(error => console.error('Error:', error));
    });
}

function resendMessage(event, messageId) {
    if (event) event.stopPropagation();
    showConfirmation('Renvoyer ce message ?', function() {
        fetch(`/messages/message/${messageId}/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.text())
        .then(data => {
            window.location.href = `/messages/compose/?resend=${messageId}`;
        })
        .catch(error => console.error('Error:', error));
    });
}

function deleteSentMessage(event, messageId) {
    if (event) event.stopPropagation();
    showConfirmation('Supprimer ce message envoyé ? Cette action est irréversible.', function() {
        fetch(`/messages/message/${messageId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`[data-message-id="${messageId}"]`);
                if (row) {
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                    }, 300);
                }
            } else {
                alert('Erreur: ' + (data.error || 'Impossible de supprimer le message'));
            }
        })
        .catch(error => console.error('Error:', error));
    });
}

function deleteSelectedSentMessages() {
    if (selectedMessages.size === 0) return;
    
    console.log('IDs sélectionnés pour suppression:', Array.from(selectedMessages));
    
    showConfirmation(`Supprimer ${selectedMessages.size} message(s) ? Cette action est irréversible.`, function() {
        selectedMessages.forEach(id => {
            deleteSentMessage(null, id);
        });
        selectedMessages.clear();
        updateBulkActions();
    });
}

// Fonctions utilitaires
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Navigation
function goToPage(page) {
    window.location.href = `?page=${page}`;
}

function refreshSentMessages(event) {
    const btn = event.target.closest('.action-btn');
    if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

// Modal de confirmation
function showConfirmation(message, callback) {
    document.getElementById('confirmModalBody').textContent = message;
    currentAction = callback;
    confirmModal.show();
}

// Raccourcis clavier
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + N pour nouveau message
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            window.location.href = "{% url 'messagerie:compose' %}";
        }
        
        // Ctrl/Cmd + F pour recherche
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            document.getElementById('sentSearch').focus();
        }
    });
}

function animateSentRows() {
    const rows = document.querySelectorAll('.sent-row');
    rows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
        row.classList.add('animate__animated', 'animate__fadeIn');
    });
}

// Inclure animate.css
const animateCSS = document.createElement('link');
animateCSS.rel = 'stylesheet';
animateCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css';
document.head.appendChild(animateCSS);
</script>
{% endblock %}

{% block extra_modals %}
<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                Êtes-vous sûr de vouloir effectuer cette action ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirmer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}