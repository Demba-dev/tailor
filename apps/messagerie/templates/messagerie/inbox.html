{% extends 'base.html' %}
{% load static %}

{% block title %}Messagerie | {{ site_settings.nom_atelier }}{% endblock %}

{% block extra_css %}
<style>
    .messaging-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* Header avec statistiques */
    .messages-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }
    
    .messages-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    }
    
    .header-content {
        position: relative;
        z-index: 2;
    }
    
    .header-title {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .header-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    /* Tabs améliorées */
    .messages-tabs {
        display: flex;
        background: white;
        border-radius: 16px;
        padding: 0.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
        border: 1px solid #e2e8f0;
    }
    
    .tab-item {
        flex: 1;
        padding: 1rem 1.5rem;
        border: none;
        background: none;
        border-radius: 12px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        position: relative;
    }
    
    .tab-item:hover {
        background: #f8fafc;
        color: #475569;
    }
    
    .tab-item.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    
    .tab-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        font-size: 0.7rem;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-weight: 700;
    }
    
    /* Barre d'actions */
    .messages-toolbar {
        background: white;
        border-radius: 16px;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .toolbar-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .toolbar-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .search-box {
        position: relative;
        width: 300px;
    }
    
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
    }
    
    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }
    
    .filter-dropdown {
        position: relative;
    }
    
    .filter-btn {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-weight: 500;
        color: #475569;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .filter-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    
    .action-btn {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.75rem;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    .action-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #1e293b;
    }
    
    .action-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .action-btn.primary:hover {
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        transform: translateY(-2px);
    }
    
    /* Table améliorée */
    .messages-table-container {
        background: white;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }
    
    .messages-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #e2e8f0;
    }
    
    .table-header th {
        padding: 1.25rem 1.5rem;
        font-weight: 600;
        color: #475569;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
    }
    
    .table-header th:first-child {
        border-radius: 20px 0 0 0;
    }
    
    .table-header th:last-child {
        border-radius: 0 20px 0 0;
    }
    
    .message-row {
        border-bottom: 1px solid #f1f5f9;
        transition: all 0.2s ease;
        position: relative;
        background: white;
    }
    
    .message-row:last-child {
        border-bottom: none;
    }
    
    .message-row:hover {
        background: #f8fafc;
        transform: translateX(4px);
    }
    
    .message-row.unread {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%);
        border-left: 3px solid #3b82f6;
    }
    
    .message-row.unread:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.08) 100%);
    }
    
    .message-row.selected {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }
    
    .message-row td {
        padding: 1.25rem 1.5rem;
        border: none;
        vertical-align: middle;
    }
    
    /* Checkbox */
    .message-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #cbd5e1;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }
    
    .message-checkbox:checked {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
    }
    
    /* Avatar et expéditeur */
    .sender-cell {
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 200px;
    }
    
    .sender-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
    }
    
    .sender-info {
        flex: 1;
        min-width: 0;
    }
    
    .sender-name {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .sender-email {
        font-size: 0.85rem;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Sujet et message */
    .subject-cell {
        min-width: 300px;
        max-width: 400px;
    }
    
    .subject-content {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .subject-text {
        font-weight: 500;
        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }
    
    .message-preview {
        font-size: 0.9rem;
        color: #64748b;
        margin-top: 0.25rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    /* Badges */
    .message-badges {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .badge-new {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        font-size: 0.7rem;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .badge-important {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        font-size: 0.7rem;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    .badge-attachment {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        font-size: 0.7rem;
        padding: 0.125rem 0.5rem;
        border-radius: 10px;
        font-weight: 600;
    }
    
    /* Date */
    .date-cell {
        text-align: center;
        min-width: 120px;
    }
    
    .date-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }
    
    .date-day {
        font-weight: 600;
        color: #1e293b;
    }
    
    .date-time {
        font-size: 0.85rem;
        color: #64748b;
    }
    
    /* Actions */
    .actions-cell {
        text-align: right;
        min-width: 150px;
    }
    
    .actions-container {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    .action-icon-btn {
        background: none;
        border: none;
        padding: 0.5rem;
        color: #94a3b8;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }
    
    .action-icon-btn:hover {
        background: #f1f5f9;
        color: #475569;
    }
    
    .action-icon-btn:active {
        transform: scale(0.95);
    }
    
    .action-icon-btn.important:hover {
        color: #f59e0b;
    }
    
    .action-icon-btn.archive:hover {
        color: #10b981;
    }
    
    .action-icon-btn.delete:hover {
        color: #ef4444;
    }
    
    .action-icon-btn i {
        pointer-events: none;
    }
    
    .btn-read {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-read:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    
    /* État vide */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }
    
    .empty-state-icon {
        width: 80px;
        height: 80px;
        border-radius: 20px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #94a3b8;
        margin: 0 auto 1.5rem;
    }
    
    .empty-state-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }
    
    .empty-state-subtitle {
        color: #64748b;
        margin-bottom: 2rem;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    
    /* Pagination */
    .messages-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: white;
        border-top: 1px solid #e2e8f0;
    }
    
    .pagination-info {
        font-size: 0.9rem;
        color: #64748b;
    }
    
    .pagination-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .pagination-btn {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .pagination-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }
    
    .pagination-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }
    
    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message-row {
        animation: fadeIn 0.3s ease forwards;
        opacity: 0;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
        .messages-toolbar {
            flex-direction: column;
            gap: 1rem;
        }
        
        .toolbar-left,
        .toolbar-right {
            width: 100%;
        }
        
        .search-box {
            width: 100%;
        }
        
        .messages-table {
            display: block;
            overflow-x: auto;
        }
        
        .sender-cell {
            min-width: 150px;
        }
        
        .subject-cell {
            min-width: 200px;
        }
    }
    
    @media (max-width: 768px) {
        .messages-header {
            padding: 1.5rem;
        }
        
        .header-title {
            font-size: 1.5rem;
        }
        
        .messages-tabs {
            flex-direction: column;
            padding: 0.25rem;
        }
        
        .tab-item {
            padding: 0.75rem;
        }
        
        .actions-container {
            flex-direction: column;
        }
        
        .btn-read {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="messaging-container">
    {% csrf_token %}
    <!-- En-tête avec statistiques -->
    <div class="messages-header animate__animated animate__fadeIn">
        <div class="header-content">
            <h1 class="header-title">
                <i class="fas fa-envelope-open-text"></i>
                Messagerie Interne
            </h1>
            <p class="header-subtitle">
                Consultez vos messages et communiquez avec l'équipe
            </p>
        </div>
    </div>

    <!-- Onglets de navigation -->
    <div class="messages-tabs">
        <a href="{% url 'messagerie:inbox' %}" class="tab-item {% if active_tab == 'inbox' %}active{% endif %}" onclick="event.preventDefault(); showAllMessages();">
            <i class="fas fa-inbox"></i>
            <span>Boîte de réception</span>
            {% if unread_count %}
            <span class="tab-badge">{{ unread_count }}</span>
            {% endif %}
        </a>
        
        <a href="{% url 'messagerie:sent_messages' %}" class="tab-item {% if active_tab == 'sent' %}active{% endif %}">
            <i class="fas fa-paper-plane"></i>
            <span>Messages envoyés</span>
        </a>
        
        <button class="tab-item" onclick="showDrafts()">
            <i class="fas fa-file-alt"></i>
            <span>Brouillons</span>
        </button>
        
        <button class="tab-item" onclick="showArchived()">
            <i class="fas fa-archive"></i>
            <span>Archivés</span>
        </button>
        
        <button class="tab-item" onclick="showImportant()">
            <i class="fas fa-star"></i>
            <span>Importants</span>
        </button>
    </div>

    <!-- Barre d'outils -->
    <div class="messages-toolbar">
        <div class="toolbar-left">
            <!-- Checkbox pour sélection multiple -->
            <input type="checkbox" id="selectAll" class="message-checkbox" onchange="toggleSelectAll(this)">
            
            <!-- Boutons d'action en masse -->
            <div class="btn-group" id="bulkActions" style="display: none;">
                <button class="action-btn" onclick="markSelectedAsRead()" title="Marquer comme lu">
                    <i class="fas fa-envelope-open"></i>
                </button>
                <button class="action-btn" onclick="markSelectedAsImportant()" title="Marquer comme important">
                    <i class="fas fa-star"></i>
                </button>
                <button class="action-btn" onclick="archiveSelected()" title="Archiver">
                    <i class="fas fa-archive"></i>
                </button>
                <button class="action-btn" onclick="deleteSelected()" title="Supprimer">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <!-- Barre de recherche -->
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" 
                       class="search-input" 
                       placeholder="Rechercher dans les messages..."
                       id="messageSearch"
                       onkeyup="searchMessages()">
            </div>
        </div>
        
        <div class="toolbar-right">
            <!-- Filtres -->
            <div class="filter-dropdown">
                <button class="filter-btn">
                    <i class="fas fa-filter"></i>
                    <span>Filtrer</span>
                    <i class="fas fa-chevron-down ms-2"></i>
                </button>
            </div>
            
            <!-- Actions -->
            <button class="action-btn" onclick="refreshMessages(event)" title="Actualiser">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <a href="{% url 'messagerie:compose' %}" class="action-btn primary" title="Nouveau message">
                <i class="fas fa-paper-plane"></i>
            </a>
        </div>
    </div>

    <!-- Table des messages -->
    <div class="messages-table-container">
        {% if received_messages %}
        <table class="messages-table">
            <thead class="table-header">
                <tr>
                    <th style="width: 40px;"></th>
                    <th style="min-width: 250px;">Expéditeur</th>
                    <th style="min-width: 400px;">Sujet</th>
                    <th style="width: 150px;">Date</th>
                    <th style="width: 200px;" class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for msg in received_messages %}
                <tr class="message-row {% if not msg.is_read %}unread{% endif %}" 
                    data-message-id="{{ msg.pk }}"
                    onclick="toggleMessageSelection(event, this)">
                    <td>
                        <input type="checkbox" 
                               class="message-checkbox message-select" 
                               value="{{ msg.pk }}"
                               onclick="event.stopPropagation()">
                    </td>
                    
                    <td>
                        <div class="sender-cell">
                            <div class="sender-avatar">
                                {{ msg.sender.username|first|upper }}
                            </div>
                            <div class="sender-info">
                                <div class="sender-name">
                                    {{ msg.sender.get_full_name|default:msg.sender.username }}
                                </div>
                                <div class="sender-email">
                                    {{ msg.sender.email|default:msg.sender.username }}
                                </div>
                            </div>
                        </div>
                    </td>
                    
                    <td class="subject-cell">
                        <div class="subject-content">
                            <div class="subject-text">
                                {{ msg.subject|default:"(Sans objet)" }}
                            </div>
                            {% if not msg.is_read %}
                            <span class="badge-new">Nouveau</span>
                            {% endif %}
                            {% if msg.is_important %}
                            <span class="badge-important">
                                <i class="fas fa-star me-1"></i>Important
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="message-preview">
                            {{ msg.body|truncatechars:100 }}
                        </div>
                        
                        {% if msg.attachments.exists %}
                        <div class="message-badges">
                            <span class="badge-attachment">
                                <i class="fas fa-paperclip me-1"></i>
                                {{ msg.attachments.count }}
                            </span>
                        </div>
                        {% endif %}
                    </td>
                    
                    <td class="date-cell">
                        <div class="date-content">
                            <div class="date-day">
                                {{ msg.created_at|date:"d M Y" }}
                            </div>
                            <div class="date-time">
                                {{ msg.created_at|date:"H:i" }}
                            </div>
                        </div>
                    </td>
                    
                    <td class="actions-cell">
                        <div class="actions-container">
                            <button type="button" class="action-icon-btn important" 
                                    onclick="toggleImportant(event, '{{ msg.pk }}')"
                                    title="Marquer comme important">
                                <i class="fas fa-star"></i>
                            </button>
                            
                            <button type="button" class="action-icon-btn archive" 
                                    onclick="archiveMessage(event, '{{ msg.pk }}')"
                                    title="Archiver">
                                <i class="fas fa-archive"></i>
                            </button>
                            
                            <button type="button" class="action-icon-btn delete" 
                                    onclick="deleteMessage(event, '{{ msg.pk }}')"
                                    title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                            
                            <a href="{% url 'messagerie:message_detail' msg.pk %}" 
                               class="btn-read"
                               onclick="markAsRead('{{ msg.pk }}')">
                                <i class="fas fa-eye"></i>
                                Lire
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        <div class="messages-pagination">
            <div class="pagination-info">
                Affichage de {{ received_messages.start_index|default:1 }} à {{ received_messages.end_index|default:received_messages|length }} sur {{ received_messages.paginator.count }} messages
            </div>
            
            <div class="pagination-controls">
                {% if received_messages.has_previous %}
                <button class="pagination-btn" onclick="goToPage('{{ received_messages.previous_page_number }}')">
                    <i class="fas fa-chevron-left"></i>
                    Précédent
                </button>
                {% endif %}
                
                {% for num in received_messages.paginator.page_range %}
                    {% if num == received_messages.number %}
                    <button class="pagination-btn active">{{ num }}</button>
                    {% else %}
                        {% if num > received_messages.number|add:"-3" and num < received_messages.number|add:"3" %}
                        <button class="pagination-btn" onclick="goToPage('{{ num }}')">{{ num }}</button>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                
                {% if received_messages.has_next %}
                <button class="pagination-btn" onclick="goToPage('{{ received_messages.next_page_number }}')">
                    Suivant
                    <i class="fas fa-chevron-right"></i>
                </button>
                {% endif %}
            </div>
        </div>
        
        {% else %}
        <!-- État vide -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-envelope-open"></i>
            </div>
            <h3 class="empty-state-title">Votre boîte de réception est vide</h3>
            <p class="empty-state-subtitle">
                Vous n'avez pas encore reçu de messages. Commencez une conversation avec votre équipe ou vos clients.
            </p>
            <a href="{% url 'messagerie:compose' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-paper-plane me-2"></i>
                Écrire votre premier message
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedMessages = new Set();
let currentAction = null;
let confirmModal = null;

document.addEventListener('DOMContentLoaded', function() {
    // Créer une instance unique de la modal de confirmation
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    
    // Initialiser les fonctionnalités
    initializeMessageTable();
    initializeSearch();
    initializeKeyboardShortcuts();
    
    // Auto-refresh des messages
    startAutoRefresh();
    
    // Attacher le listener du bouton de confirmation
    const confirmBtn = document.getElementById('confirmActionBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            if (currentAction) {
                currentAction();
                currentAction = null;
            }
            confirmModal.hide();
        });
    }
});

function initializeMessageTable() {
    // Animation des lignes
    const rows = document.querySelectorAll('.message-row');
    rows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
        row.classList.add('animate__animated', 'animate__fadeIn');
    });
    
    // Gestion des clics sur les lignes
    rows.forEach(row => {
        row.addEventListener('click', function(e) {
            if (!e.target.closest('.action-icon-btn') && !e.target.closest('.btn-read')) {
                const checkbox = this.querySelector('.message-select');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    updateMessageSelection(checkbox);
                }
            }
        });
    });
}

function toggleMessageSelection(event, row) {
    const checkbox = row.querySelector('.message-select');
    if (checkbox && !event.target.closest('.action-icon-btn') && !event.target.closest('.btn-read')) {
        checkbox.checked = !checkbox.checked;
        updateMessageSelection(checkbox);
    }
}

function updateMessageSelection(checkbox) {
    const messageId = checkbox.value;
    
    if (checkbox.checked) {
        selectedMessages.add(messageId);
        checkbox.closest('.message-row').classList.add('selected');
    } else {
        selectedMessages.delete(messageId);
        checkbox.closest('.message-row').classList.remove('selected');
    }
    
    updateBulkActions();
}

function toggleSelectAll(checkbox) {
    const selectAll = checkbox.checked;
    const messageCheckboxes = document.querySelectorAll('.message-select');
    
    selectedMessages.clear();
    
    messageCheckboxes.forEach(cb => {
        cb.checked = selectAll;
        const row = cb.closest('.message-row');
        if (selectAll) {
            selectedMessages.add(cb.value);
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    });
    
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    if (selectedMessages.size > 0) {
        bulkActions.style.display = 'flex';
        selectAllCheckbox.checked = true;
    } else {
        bulkActions.style.display = 'none';
        selectAllCheckbox.checked = false;
    }
}

// Actions en masse
function markSelectedAsRead() {
    if (selectedMessages.size === 0) return;
    
    showConfirmation(`Marquer ${selectedMessages.size} message(s) comme lu ?`, function() {
        selectedMessages.forEach(id => {
            markAsRead(id);
        });
        selectedMessages.clear();
        updateBulkActions();
    });
}

function markSelectedAsImportant() {
    if (selectedMessages.size === 0) return;
    
    showConfirmation(`Marquer ${selectedMessages.size} message(s) comme important ?`, function() {
        // Implémenter la logique serveur
        selectedMessages.forEach(id => {
            toggleImportantServer(id, true);
        });
        selectedMessages.clear();
        updateBulkActions();
    });
}

function archiveSelected() {
    if (selectedMessages.size === 0) return;
    
    showConfirmation(`Archiver ${selectedMessages.size} message(s) ?`, function() {
        // Implémenter la logique serveur
        selectedMessages.forEach(id => {
            archiveMessageServer(id);
        });
        selectedMessages.clear();
        updateBulkActions();
    });
}

function deleteSelected() {
    if (selectedMessages.size === 0) return;
    
    showConfirmation(`Supprimer ${selectedMessages.size} message(s) ? Cette action est irréversible.`, function() {
        // Implémenter la logique serveur
        selectedMessages.forEach(id => {
            deleteMessageServer(id);
        });
        selectedMessages.clear();
        updateBulkActions();
    });
}

// Actions individuelles
function markAsRead(messageId) {
    // Envoyer une requête AJAX au serveur
    fetch(`/messages/message/${messageId}/mark-read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`[data-message-id="${messageId}"]`);
            if (row) {
                row.classList.remove('unread');
                const badge = row.querySelector('.badge-new');
                if (badge) badge.remove();
                
                // Mettre à jour le compteur
                updateUnreadCount();
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

function toggleImportant(event, messageId) {
    event.stopPropagation();
    
    // Basculer visuellement
    const btn = event.target.closest('.important');
    const row = document.querySelector(`[data-message-id="${messageId}"]`);
    const badge = row.querySelector('.badge-important');
    
    if (badge) {
        badge.remove();
        btn.innerHTML = '<i class="fas fa-star"></i>';
        btn.title = 'Marquer comme important';
    } else {
        const newBadge = document.createElement('span');
        newBadge.className = 'badge-important';
        newBadge.innerHTML = '<i class="fas fa-star me-1"></i>Important';
        row.querySelector('.subject-content').appendChild(newBadge);
        
        btn.innerHTML = '<i class="fas fa-star text-warning"></i>';
        btn.title = 'Retirer des importants';
    }
}

function archiveMessage(event, messageId) {
    event.stopPropagation();
    
    showConfirmation('Archiver ce message ?', function() {
        fetch(`/messages/message/${messageId}/archive/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`[data-message-id="${messageId}"]`);
                if (row) {
                    row.style.opacity = '0.5';
                    setTimeout(() => {
                        row.style.display = 'none';
                    }, 300);
                }
            } else {
                alert('Erreur: ' + (data.error || 'Impossible d\'archiver le message'));
            }
        })
        .catch(error => console.error('Error:', error));
    });
}

function deleteMessage(event, messageId) {
    event.stopPropagation();
    
    showConfirmation('Supprimer ce message ? Cette action est irréversible.', function() {
        fetch(`/messages/message/${messageId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`[data-message-id="${messageId}"]`);
                if (row) {
                    row.style.opacity = '0';
                    row.style.transform = 'slideOut';
                    setTimeout(() => {
                        row.remove();
                        updateUnreadCount();
                    }, 300);
                }
            } else {
                alert('Erreur: ' + (data.error || 'Impossible de supprimer le message'));
            }
        })
        .catch(error => console.error('Error:', error));
    });
}

// Actions serveur en masse
function toggleImportantServer(messageId, important) {
    fetch(`/messages/message/${messageId}/toggle-important/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ important: important })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Error:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

function archiveMessageServer(messageId) {
    fetch(`/messages/message/${messageId}/archive/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`[data-message-id="${messageId}"]`);
            if (row) {
                row.style.opacity = '0.5';
                setTimeout(() => {
                    row.style.display = 'none';
                }, 300);
            }
        } else {
            console.error('Error:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

function deleteMessageServer(messageId) {
    fetch(`/messages/message/${messageId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`[data-message-id="${messageId}"]`);
            if (row) {
                row.remove();
                updateUnreadCount();
            }
        } else {
            console.error('Error:', data.error);
        }
    })
    .catch(error => console.error('Error:', error));
}

// Recherche
function initializeSearch() {
    const searchInput = document.getElementById('messageSearch');
    if (!searchInput) return;
    
    // Raccourci clavier Ctrl+F
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            searchInput.focus();
        }
    });
    
    // Effacer la recherche avec Échap
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            searchMessages();
        }
    });
}

function searchMessages() {
    const query = document.getElementById('messageSearch').value.toLowerCase();
    const rows = document.querySelectorAll('.message-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(query)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Navigation
function goToPage(page) {
    window.location.href = `?page=${page}`;
}

function refreshMessages(event) {
    const btn = event.target.closest('.action-btn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

// Modal de confirmation
function showConfirmation(message, callback) {
    document.getElementById('confirmModalBody').textContent = message;
    currentAction = callback;
    confirmModal.show();
}

// Raccourcis clavier
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + A pour sélectionner tout
        if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
            e.preventDefault();
            const selectAll = document.getElementById('selectAll');
            selectAll.checked = !selectAll.checked;
            toggleSelectAll(selectAll);
        }
        
        // Ctrl/Cmd + N pour nouveau message
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            window.location.href = "{% url 'messagerie:compose' %}";
        }
        
        // Échap pour désélectionner tout
        if (e.key === 'Escape') {
            selectedMessages.clear();
            document.querySelectorAll('.message-select').forEach(cb => {
                cb.checked = false;
                cb.closest('.message-row').classList.remove('selected');
            });
            updateBulkActions();
        }
    });
}

// Auto-refresh
let refreshInterval;
function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        // Vérifier les nouveaux messages (simplifié)
        console.log('Checking for new messages...');
    }, 30000); // Toutes les 30 secondes
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
}

// Fonctions utilitaires
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function updateUnreadCount() {
    // Implémenter la mise à jour du compteur
    const unreadCount = document.querySelectorAll('.message-row.unread').length;
    const badge = document.querySelector('.tab-badge');
    if (badge) {
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Onglets supplémentaires
function showDrafts() {
    const rows = document.querySelectorAll('.message-row');
    rows.forEach(row => {
        row.style.display = 'none';
    });
    console.log('Onglet Brouillons activé (vide pour l\'instant)');
}

function showArchived() {
    const rows = document.querySelectorAll('.message-row');
    let archivedCount = 0;
    rows.forEach(row => {
        const isArchived = row.getAttribute('data-archived') === 'true';
        if (isArchived) {
            row.style.display = '';
            archivedCount++;
        } else {
            row.style.display = 'none';
        }
    });
    console.log(`Messages archivés affichés: ${archivedCount}`);
}

function showImportant() {
    const rows = document.querySelectorAll('.message-row');
    let importantCount = 0;
    rows.forEach(row => {
        const isImportant = row.querySelector('.badge-important') !== null;
        if (isImportant) {
            row.style.display = '';
            importantCount++;
        } else {
            row.style.display = 'none';
        }
    });
    console.log(`Messages importants affichés: ${importantCount}`);
}

function showAllMessages() {
    const rows = document.querySelectorAll('.message-row');
    rows.forEach(row => {
        row.style.display = '';
    });
    console.log(`Affichage de tous les messages: ${rows.length}`);
}

// Inclure animate.css
const animateCSS = document.createElement('link');
animateCSS.rel = 'stylesheet';
animateCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css';
</script>
{% endblock %}

{% block extra_modals %}
<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                Êtes-vous sûr de vouloir effectuer cette action ?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">Confirmer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}