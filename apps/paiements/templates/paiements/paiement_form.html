<!DOCTYPE html>
{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{% if form.instance.pk %}Modifier le paiement{% else %}Nouveau paiement{% endif %} - TAILOR{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clients.css' %}">
<style>
    /* Styles spécifiques pour le formulaire de paiement */
    .payment-header {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .payment-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: rgba(255,255,255,0.1);
        transform: rotate(30deg);
    }
    
    .payment-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }
    
    .amount-display {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .currency-symbol {
        font-size: 2rem;
        vertical-align: top;
        margin-right: 5px;
    }
    
    .amount-input-group {
        position: relative;
    }
    
    .amount-input-group .form-control {
        padding-left: 3rem;
        padding-right: 3rem;
        font-size: 1.5rem;
        font-weight: 600;
        text-align: center;
        height: 70px;
        border: 3px solid #e9ecef;
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .amount-input-group .form-control:focus {
        border-color: #48bb78;
        box-shadow: 0 0 0 0.25rem rgba(72, 187, 120, 0.25);
        transform: translateY(-2px);
    }
    
    .amount-input-group .input-symbol {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.5rem;
        font-weight: 600;
        color: #48bb78;
        pointer-events: none;
    }
    
    .amount-input-group .input-symbol-left {
        left: 1.5rem;
    }
    
    .amount-input-group .input-symbol-right {
        right: 1.5rem;
    }
    
    .payment-methods {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 2rem;
    }
    
    .payment-method-card {
        flex: 1;
        min-width: 120px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        position: relative;
    }
    
    .payment-method-card:hover {
        border-color: #48bb78;
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(72, 187, 120, 0.1);
    }
    
    .payment-method-card.active {
        border-color: #48bb78;
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
    }
    
    .payment-method-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .payment-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .summary-row:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.2rem;
    }
    
    .receipt-preview {
        background: white;
        border: 2px dashed #e9ecef;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 2rem;
    }
    
    .receipt-preview:hover {
        border-color: #48bb78;
        background: rgba(72, 187, 120, 0.05);
    }
    
    .receipt-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        margin: 0 auto 1rem;
    }
    
    .quick-amounts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
        margin-bottom: 2rem;
    }
    
    .quick-amount {
        padding: 1rem;
        text-align: center;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .quick-amount:hover {
        border-color: #48bb78;
        background: rgba(72, 187, 120, 0.1);
        transform: translateY(-2px);
    }
    
    .quick-amount.active {
        border-color: #48bb78;
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
    }
    
    .payment-details-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border-left: 4px solid #48bb78;
        margin-bottom: 2rem;
    }
    
    .validation-message {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .payment-success {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
    }
    
    .payment-warning {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
    }
</style>

{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}"><i class="fas fa-home"></i></a></li>
        <li class="breadcrumb-item"><a href="{% url 'paiements:paiement_list' %}">Paiements</a></li>
        {% if form.instance.pk %}
        <li class="breadcrumb-item"><a href="{% url 'paiements:paiement_detail' form.instance.pk %}">Paiement #{{ form.instance.id }}</a></li>
        <li class="breadcrumb-item active">Modifier</li>
        {% else %}
        <li class="breadcrumb-item active">Nouveau paiement</li>
        {% endif %}
    </ol>
</nav>
{% endblock %}

{% block page_title %}
<div class="payment-header">
    <div class="text-center">
        <div class="payment-icon">
            <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus-circle{% endif %}"></i>
        </div>
        <h1 class="h2 mb-2">
            {% if form.instance.pk %}
            Modifier le paiement
            {% else %}
            Nouveau paiement
            {% endif %}
        </h1>
        <p class="mb-0 opacity-75">
            {% if form.instance.pk %}
            Mettez à jour les informations de ce paiement
            {% else %}
            Enregistrez un nouveau paiement pour une commande
            {% endif %}
        </p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <form method="post" id="paymentForm" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <!-- Messages d'erreur globaux -->
            {% if form.errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                <div>
                    <h5 class="alert-heading">Veuillez corriger les erreurs suivantes :</h5>
                    <ul class="mb-0 mt-2">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }} :</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            
            <!-- Section Commande -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Informations de la commande</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.commande.id_for_label }}" class="form-label required">
                                <i class="fas fa-scroll me-1"></i>Commande
                            </label>
                            <div class="input-group">
                                {{ form.commande }}
                                <button class="btn btn-outline-primary" type="button" onclick="showOrderDetails()">
                                    <i class="fas fa-search"></i> Voir
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Veuillez sélectionner une commande.
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <i class="fas fa-calendar-alt me-1"></i>Date de commande
                            </label>
                            <div class="form-control bg-light" id="orderDate">
                                {% if form.instance.commande %}
                                {{ form.instance.commande.date_commande|date:"d/m/Y" }}
                                {% else %}
                                Sélectionnez une commande
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Détails de la commande sélectionnée -->
                    <div id="orderDetails" class="d-none">
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <strong>Client :</strong>
                                        <span id="clientName">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Habit :</strong>
                                        <span id="habitName">-</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <strong>Prix total :</strong>
                                        <span id="totalAmount" class="fw-bold">- CFA</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Déjà payé :</strong>
                                        <span id="paidAmount" class="fw-bold text-success">- CFA</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Reste à payer :</strong>
                                        <span id="remainingAmount" class="fw-bold text-danger">- CFA</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section Montant -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-euro-sign me-2"></i>Montant du paiement</h5>
                </div>
                <div class="card-body">
                    <!-- Montant principal -->
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-8">
                            <div class="amount-input-group">
                                
                                {{ form.montant |add_class:"form-control" }}
                                <span class="input-symbol input-symbol-right">CFA</span>
                            </div>
                            <div class="invalid-feedback">
                                Veuillez saisir un montant valide.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Montants rapides -->
                    <div class="mb-4">
                        <label class="form-label mb-3">
                            <i class="fas fa-bolt me-1"></i>Montants rapides
                        </label>
                        <div class="quick-amounts">
                            <div class="quick-amount" data-amount="1000">1000CFA</div>
                            <div class="quick-amount" data-amount="2000">2000CFA</div>
                            <div class="quick-amount" data-amount="5000">5000CFA</div>
                            <div class="quick-amount" data-amount="10000">10000CFA</div>
                            <div class="quick-amount" data-amount="20000">20000CFA</div>

                            <div class="quick-amount" onclick="calculateRemaining()">Reste</div>
                        </div>
                    </div>
                    
                    <!-- Sommaire financier -->
                    <div class="payment-summary">
                        <h6 class="mb-3"><i class="fas fa-calculator me-2"></i>Récapitulatif</h6>
                        <div class="summary-row">
                            <span>Montant de la commande :</span>
                            <span id="summaryTotal"> CFA</span>
                        </div>
                        <div class="summary-row">
                            <span>Déjà payé :</span>
                            <span id="summaryPaid" class="text-success"> CFA</span>
                        </div>
                        <div class="summary-row">
                            <span>Montant actuel :</span>
                            <span id="summaryCurrent" class="fw-bold"> CFA</span>
                        </div>
                        <div class="summary-row">
                            <span>Reste après paiement :</span>
                            <span id="summaryRemaining" class="fw-bold text-danger"> CFA</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section Méthode de paiement -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Méthode de paiement</h5>
                </div>
                <div class="card-body">
                    <div class="payment-methods">
                        <div class="payment-method-card" data-method="especes">
                            <div class="payment-method-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="payment-method-name">Espèces</div>
                        </div>
                        
                        <div class="payment-method-card" data-method="carte">
                            <div class="payment-method-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="payment-method-name">Carte bancaire</div>
                        </div>
                        
                        <div class="payment-method-card" data-method="cheque">
                            <div class="payment-method-icon">
                                <i class="fas fa-money-check"></i>
                            </div>
                            <div class="payment-method-name">Chèque</div>
                        </div>
                        
                        <div class="payment-method-card" data-method="virement">
                            <div class="payment-method-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <div class="payment-method-name">Virement</div>
                        </div>
                    </div>
                    
                    <input type="hidden" name="mode_paiement" id="paymentMethod" value="{{ form.mode_paiement.value|default:'espece' }}">
                    
                    <!-- Détails supplémentaires selon la méthode -->
                    <div id="methodDetails" class="mt-4">
                        {% if form.mode_paiement.value == 'carte' or not form.instance.pk %}
                        <div class="row" id="cardDetails">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Numéro de carte</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-credit-card"></i>
                                    </span>
                                    <input type="text" class="form-control" placeholder="XXXX XXXX XXXX XXXX" maxlength="19">
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Date d'expiration</label>
                                <input type="text" class="form-control" placeholder="MM/AA">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">CVV</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" >
                                    <span class="input-group-text">
                                        <i class="fas fa-lock"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if form.mode_paiement.value == 'cheque' or not form.instance.pk %}
                        <div class="row" id="checkDetails">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Numéro de chèque</label>
                                <input type="text" class="form-control" placeholder="000000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Banque émettrice</label>
                                <input type="text" class="form-control" placeholder="Nom de la banque">
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if form.mode_paiement.value == 'virement' or not form.instance.pk %}
                        <div class="row" id="transferDetails">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Référence de virement</label>
                                <input type="text" class="form-control" placeholder="Référence unique">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date d'exécution</label>
                                <input type="date" class="form-control">
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Champ caché pour la méthode -->
                    {{ form.mode_paiement }}
                </div>
            </div>
            
            <!-- Section Date et statut -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Date et statut</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_paiement.id_for_label }}" class="form-label required">
                                <i class="fas fa-calendar-day me-1"></i>Date du paiement
                            </label>
                            <div class="input-group">
                                {{ form.date_paiement }}
                                <span class="input-group-text">
                                    <i class="fas fa-calendar-alt"></i>
                                </span>
                            </div>
                            <div class="invalid-feedback">
                                Veuillez saisir une date valide.
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.statut.id_for_label }}" class="form-label required">
                                <i class="fas fa-check-circle me-1"></i>Statut
                            </label>
                            {{ form.statut|add_class:"form-select statut-select" }}
                        </div>

                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                            <i class="fas fa-sticky-note me-1"></i>Notes
                        </label>
                        {{ form.notes }}
                        <div class="form-text">
                            Notes internes concernant ce paiement (référence, détails...)
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section Reçu -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Reçu de paiement</h5>
                </div>
                <div class="card-body">
                    <div class="receipt-preview" onclick="generateReceipt()">
                        <div class="receipt-icon">
                            <i class="fas fa-print"></i>
                        </div>
                        <h5>Générer un reçu</h5>
                        <p class="text-muted mb-0">
                            Créez un reçu PDF pour ce paiement
                        </p>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sendReceipt">
                        <label class="form-check-label" for="sendReceipt">
                            <i class="fas fa-envelope me-1"></i>
                            Envoyer le reçu par email au client
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Boutons d'action -->
            <div class="d-flex justify-content-between align-items-center pt-4 border-top">
                <div>
                    <a href="{% url 'paiements:paiement_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour aux paiements
                    </a>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success btn-lg px-4">
                        <i class="fas fa-save me-2"></i>
                        {% if form.instance.pk %}Mettre à jour{% else %}Enregistrer le paiement{% endif %}
                    </button>
                    {% if not form.instance.pk %}
                    <button type="submit" name="save_and_add_another" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus-circle me-2"></i>Enregistrer et ajouter
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-outline-primary btn-lg" onclick="validatePayment()">
                        <i class="fas fa-check-circle me-2"></i>Valider
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Validation message -->
<div id="validationMessage" class="validation-message d-none">
    <div class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/cleave.js/dist/cleave.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser le sélecteur de date
    const dateField = document.getElementById('{{ form.date_paiement.id_for_label }}');
    if (dateField && !dateField.type === 'date') {
        flatpickr(dateField, {
            dateFormat: "d/m/Y",
            locale: "fr",
            defaultDate: "today",
            disableMobile: "true"
        });
    }
    
    // Auto-remplir la date si vide
    if (dateField && !dateField.value) {
        dateField.value = new Date().toLocaleDateString('fr-FR');
    }
    
    // Formatage du montant
    const amountField = document.getElementById('{{ form.montant.id_for_label }}');
    if (amountField) {
        amountField.addEventListener('input', updatePaymentSummary);
    }
    
    // Sélection des méthodes de paiement
    const methodCards = document.querySelectorAll('.payment-method-card');
    const methodField = document.getElementById('paymentMethod');
    
    methodCards.forEach(card => {
        card.addEventListener('click', function() {
            // Retirer la classe active de toutes les cartes
            methodCards.forEach(c => c.classList.remove('active'));
            
            // Ajouter la classe active à la carte cliquée
            this.classList.add('active');
            
            // Mettre à jour le champ caché
            const method = this.getAttribute('data-method');
            methodField.value = method;
            
            // Afficher les détails spécifiques
            showMethodDetails(method);
        });
    });
    
    // Initialiser la méthode sélectionnée
    const initialMethod = methodField.value || 'especes';
    document.querySelector(`.payment-method-card[data-method="${initialMethod}"]`)?.classList.add('active');
    showMethodDetails(initialMethod);
    
    // Montants rapides
    const quickAmounts = document.querySelectorAll('.quick-amount[data-amount]');
    quickAmounts.forEach(button => {
        button.addEventListener('click', function() {
            const amount = this.getAttribute('data-amount');
            amountField.value = amount;
            updatePaymentSummary();
            
            // Mettre en surbrillance le bouton sélectionné
            quickAmounts.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Charger les détails de la commande quand elle change
    const orderField = document.getElementById('{{ form.commande.id_for_label }}');
    if (orderField) {
        orderField.addEventListener('change', function() {
            loadOrderDetails(this.value);
        });
        
        // Charger les détails si une commande est déjà sélectionnée
        if (orderField.value) {
            loadOrderDetails(orderField.value);
        }
    }
    
    // Validation du formulaire
    const form = document.getElementById('paymentForm');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
            showValidationMessage('Veuillez corriger les erreurs dans le formulaire.', 'warning');
        } else {
            // Validation supplémentaire du montant
            if (!validatePaymentAmount()) {
                event.preventDefault();
                showValidationMessage('Le montant dépasse le reste à payer de la commande.', 'warning');
            }
        }
        form.classList.add('was-validated');
    });
    
    // Initialiser le résumé
    updatePaymentSummary();
});

function showMethodDetails(method) {
    // Cacher tous les détails
    document.querySelectorAll('#methodDetails > div').forEach(div => {
        div.style.display = 'none';
    });
    
    // Afficher les détails correspondants
    switch(method) {
        case 'carte':
            document.getElementById('cardDetails').style.display = 'block';
            break;
        case 'cheque':
            document.getElementById('checkDetails').style.display = 'block';
            break;
        case 'virement':
            document.getElementById('transferDetails').style.display = 'block';
            break;
    }
}

async function loadOrderDetails(orderId) {
    if (!orderId) {
        hideOrderDetails();
        return;
    }
    
    try {
        const response = await fetch(`/api/commandes/${orderId}/details/`);
        const data = await response.json();
        
        if (data.success) {
            showOrderDetails(data);
        } else {
            hideOrderDetails();
        }
    } catch (error) {
        console.error('Erreur lors du chargement des détails:', error);
        hideOrderDetails();
    }
}

function showOrderDetails(data) {
    const detailsDiv = document.getElementById('orderDetails');
    detailsDiv.classList.remove('d-none');
    
    // Mettre à jour les informations
    document.getElementById('clientName').textContent = `${data.client_prenom} ${data.client_nom}`;
    document.getElementById('habitName').textContent = data.habit_nom;
    document.getElementById('totalAmount').textContent = `${Math.round(data.prix_total)} CFA`;
    document.getElementById('paidAmount').textContent = `${Math.round(data.montant_paye)} CFA`;
    document.getElementById('remainingAmount').textContent = `${Math.round(data.reste_a_payer)} CFA`;
    document.getElementById('orderDate').textContent = data.date_commande;
    
    // Mettre à jour le résumé
    updatePaymentSummary();
}

function hideOrderDetails() {
    document.getElementById('orderDetails').classList.add('d-none');
    document.getElementById('clientName').textContent = '-';
    document.getElementById('habitName').textContent = '-';
    document.getElementById('totalAmount').textContent = '- CFA';
    document.getElementById('paidAmount').textContent = '- CFA';
    document.getElementById('remainingAmount').textContent = '- CFA';
    document.getElementById('orderDate').textContent = 'Sélectionnez une commande';
}

function updatePaymentSummary() {
    const amountField = document.getElementById('{{ form.montant.id_for_label }}');
    let currentAmount = parseFloat(amountField.value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    
    // Récupérer les données de la commande
    const total = parseFloat(document.getElementById('remainingAmount').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    const paid = parseFloat(document.getElementById('paidAmount').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    const fullTotal = parseFloat(document.getElementById('totalAmount').textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    
    // Mettre à jour le résumé
    document.getElementById('summaryTotal').textContent = Math.round(fullTotal) + ' CFA';
    document.getElementById('summaryPaid').textContent = Math.round(paid) + ' CFA';
    document.getElementById('summaryCurrent').textContent = Math.round(currentAmount) + ' CFA';

    
    const remaining = fullTotal - paid - currentAmount;
    document.getElementById('summaryRemaining').textContent = Math.round(remaining) + ' CFA';
    
    // Colorer le reste selon la valeur
    const remainingElement = document.getElementById('summaryRemaining');
    if (remaining > 0) {
        remainingElement.className = 'fw-bold text-danger';
    } else if (remaining < 0) {
        remainingElement.className = 'fw-bold text-warning';
    } else {
        remainingElement.className = 'fw-bold text-success';
    }
}

function calculateRemaining() {
    const remainingText = document.getElementById('remainingAmount').textContent;
    const remaining = parseFloat(remainingText.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    
    if (remaining > 0) {
        const amountField = document.getElementById('{{ form.montant.id_for_label }}');
        amountField.value = Math.round(remaining);  // Montant entier
        updatePaymentSummary();
        
        // Mettre en surbrillance le bouton "Reste"
        document.querySelectorAll('.quick-amount').forEach(b => b.classList.remove('active'));
        document.querySelector('.quick-amount[onclick="calculateRemaining()"]').classList.add('active');
    }
}


function validatePaymentAmount() {
    const amountField = document.getElementById('{{ form.montant.id_for_label }}');
    const currentAmount = parseFloat(amountField.value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    
    const remainingText = document.getElementById('remainingAmount').textContent;
    const remaining = parseFloat(remainingText.replace(/[^\d,]/g, '').replace(',', '.')) || Infinity;
    
    if (currentAmount > remaining) {
        showValidationMessage(`Le montant (${Math.round(currentAmount)} CFA) dépasse le reste à payer (${Math.round(remaining)} CFA).`, 'warning');
        return false;
    }
    
    if (currentAmount <= 0) {
        showValidationMessage('Le montant doit être supérieur à 0.', 'warning');
        return false;
    }
    
    return true;
}


function validatePayment() {
    const form = document.getElementById('paymentForm');
    
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        showValidationMessage('Veuillez corriger les erreurs dans le formulaire.', 'warning');
        return;
    }
    
    if (!validatePaymentAmount()) {
        return;
    }
    
    // Tout est valide
    showValidationMessage('Le paiement est valide. Vous pouvez l\'enregistrer.', 'success');
}

function generateReceipt() {
    const orderField = document.getElementById('{{ form.commande.id_for_label }}');
    const amountField = document.getElementById('{{ form.montant.id_for_label }}');
    
    if (!orderField.value || !amountField.value) {
        showValidationMessage('Veuillez d\'abord saisir la commande et le montant.', 'warning');
        return;
    }
    
    // Simulation de génération de reçu
    showValidationMessage('Génération du reçu en cours...', 'info');
    
    setTimeout(() => {
        showValidationMessage('Reçu généré avec succès !', 'success');
    }, 1000);
}

function showValidationMessage(message, type = 'info') {
    const container = document.getElementById('validationMessage');
    const toast = container.querySelector('.toast');
    
    // Mettre à jour le contenu et le style
    toast.querySelector('.toast-body').textContent = message;
    toast.className = `toast align-items-center text-white border-0`;
    
    switch(type) {
        case 'success':
            toast.classList.add('payment-success');
            break;
        case 'warning':
            toast.classList.add('payment-warning');
            break;
        case 'error':
            toast.classList.add('bg-danger');
            break;
        default:
            toast.classList.add('bg-info');
    }
    
    // Afficher le message
    container.classList.remove('d-none');
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Cacher après 5 secondes
    setTimeout(() => {
        bsToast.hide();
    }, 5000);
}

// Helper pour formater les montants
function formatCurrency(amount) {
    return Math.round(amount).toLocaleString('fr-FR') + ' CFA';
}


// Afficher les détails de la commande dans une modale
function showOrderDetailsModal() {
    // Implémenter l'affichage des détails de la commande
    const orderId = document.getElementById('{{ form.commande.id_for_label }}').value;
    if (orderId) {
        window.open(`/commandes/${orderId}/detail/`, '_blank');
    }
}

// Calcul automatique du TVA (si nécessaire)
function calculateTaxes() {
    const amountField = document.getElementById('{{ form.montant.id_for_label }}');
    const amount = parseFloat(amountField.value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
    const taxRate = 0.20; // 20% TVA
    
    const taxAmount = amount * taxRate;
    const totalWithTax = amount + taxAmount;
    
    // Mettre à jour l'affichage des taxes
    document.getElementById('taxAmount').textContent = formatCurrency(taxAmount);
    document.getElementById('totalWithTax').textContent = formatCurrency(totalWithTax);
}

// Lier le calcul des taxes au changement de montant
document.getElementById('{{ form.montant.id_for_label }}')?.addEventListener('input', calculateTaxes);
</script>

<!-- Flatpickr pour les dates -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>
{% endblock %}